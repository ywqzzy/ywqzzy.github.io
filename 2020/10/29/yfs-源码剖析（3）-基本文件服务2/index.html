<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    
    <title>yfs-源码剖析（3）--基本文件服务2 | zzywq</title>
    
    
        <meta name="keywords" content="c++ yfs 分布式">
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="mkdir&amp;amp;unlink12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879intyfs_client::mkdir(inum parent, c">
<meta name="keywords" content="c++ yfs 分布式">
<meta property="og:type" content="article">
<meta property="og:title" content="yfs-源码剖析（3）--基本文件服务2">
<meta property="og:url" content="http://ywqzzy.github.io/2020/10/29/yfs-源码剖析（3）-基本文件服务2/index.html">
<meta property="og:site_name" content="zzywq">
<meta property="og:description" content="mkdir&amp;amp;unlink12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879intyfs_client::mkdir(inum parent, c">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-10-29T04:11:00.602Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yfs-源码剖析（3）--基本文件服务2">
<meta name="twitter:description" content="mkdir&amp;amp;unlink12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879intyfs_client::mkdir(inum parent, c">
    

    
        <link rel="alternate" href="/atom.xml" title="zzywq" type="application/atom+xml">
    

    
        <link rel="icon" href="/favicon.ico">
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">
    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="/libs/jquery/plugins/cookie/1.4.1/jquery.cookie.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    
    


    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
</head>
</html>
<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">zzywq</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/">首页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">分类</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://www.gravatar.com/avatar/850545b461e31bbfebf7cb24cd11e1a8">
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/">首页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">分类</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://www.gravatar.com/avatar/850545b461e31bbfebf7cb24cd11e1a8?s=128">
            <h2 id="name">zzywq</h2>
            <h3 id="title">Programmer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Beijing, China</span>
            <a id="follow" target="_blank" href="https://github.com/ywqzzy/">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                55
                <span>文章</span>
            </div>
            <div class="article-info-block">
                20
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/ywqzzy/ywqzzy.github.io" target="_blank" title="github" class="tooltip">
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/atom.xml" target="_blank" title="rss" class="tooltip">
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            
                <aside id="sidebar">
   
        
    <div class="widget-wrap" id="categories">
        <h3 class="widget-title">
            <span>分类</span>
            &nbsp;
            <a id="allExpand" href="#">
                <i class="fa fa-angle-double-down fa-2x"></i>
            </a>
        </h3>
        
        
        
         <ul class="unstyled" id="tree"> 
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            c++
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/09/cppcon2020-Back-to-basics-The-Abstract-Machine/">cppcon2020 Back to basics: The Abstract Machine</a></li>  <li class="file"><a href="/2020/10/09/cppcon2020-Back-to-basics-The-structure-of-a-Program/">cppcon2020 Back to basics: The structure of a Program</a></li>  <li class="file"><a href="/2020/10/15/uniform-initialization/">uniform initialization</a></li>  <li class="file"><a href="/2020/10/15/Variadic-Templates/">Variadic Templates</a></li>  <li class="file"><a href="/2020/10/16/explicit关键字/">explicit关键字</a></li>  <li class="file"><a href="/2020/10/16/Type-Alias/">Type Alias & using</a></li>  <li class="file"><a href="/2020/10/16/noexcept/">noexcept</a></li>  <li class="file"><a href="/2020/10/16/decltype/">decltype</a></li>  <li class="file"><a href="/2020/10/16/lambda/">lambda</a></li>  <li class="file"><a href="/2020/10/16/Rvalue-references/">Rvalue references</a></li>  <li class="file"><a href="/2020/10/16/写一个-move-aware-class/">写一个 Move aware class</a></li>  <li class="file"><a href="/2020/10/18/Singleton-c/">Singleton--C++</a></li>  <li class="file"><a href="/2020/10/18/智能指针/">智能指针</a></li>  <li class="file"><a href="/2020/10/18/RAII/">RAII</a></li>  <li class="file"><a href="/2020/10/18/pImpl/">pImpl</a></li>  <li class="file"><a href="/2020/10/18/对象池/">对象池</a></li>  <li class="file"><a href="/2020/10/19/Noncopyable/">Noncopyable</a></li>  <li class="file"><a href="/2020/10/19/实现string类/">实现string类</a></li>  <li class="file"><a href="/2020/10/19/c-11计时器/">C++11 计时器</a></li>  <li class="file"><a href="/2020/10/19/实现数据库连接池/">实现数据库连接池</a></li>  <li class="file"><a href="/2020/10/20/std-bind-std-function/">std:function&std:bind&</a></li>  <li class="file"><a href="/2020/11/03/c-资源管理/">c++资源管理</a></li>  <li class="file"><a href="/2020/11/03/智能指针-move-sementic/">智能指针(move sementic)</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            c++ 多线程
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/19/实现简单的线程安全Queue/">实现简单的线程安全Queue</a></li>  <li class="file"><a href="/2020/10/19/实现blockingqueue/">实现blockingqueue</a></li>  <li class="file"><a href="/2020/10/21/muduo-Blocking-queue/">muduo Blocking queue</a></li>  <li class="file"><a href="/2020/10/21/muduo-CountdownLatch/">muduo CountdownLatch</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            io
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/12/reactor-proactor/">reactor & proactor</a></li>  <li class="file"><a href="/2020/10/12/同步-IO-和异步-IO/">同步 IO 和异步 IO</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            leetcode
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/23/leetcode148排序链表/">leetcode148排序链表</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            muduo
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/21/muduo封装MutexLock-MutexLockGuard-Condition/">muduo封装MutexLock MutexLockGuard Condition</a></li>  <li class="file"><a href="/2020/10/22/muduo-BoundedBlockingQueue/">muduo BoundedBlockingQueue</a></li>  <li class="file"><a href="/2020/10/23/muduo-Thread/">muduo Thread</a></li>  <li class="file"><a href="/2020/10/27/muduo-Timestamp/">muduo Timestamp </a></li>  <li class="file"><a href="/2020/10/27/muduo-exception/">muduo exception</a></li>  <li class="file"><a href="/2020/10/27/muduo-CurrentThread/">muduo CurrentThread</a></li>  <li class="file"><a href="/2020/10/27/muduo-FileUtil/">muduo FileUtil</a></li>  <li class="file"><a href="/2020/10/27/muduo-date/">muduo date</a></li>  <li class="file"><a href="/2020/10/27/muduo-atomic/">muduo atomic</a></li>  <li class="file"><a href="/2020/10/27/muduo-ProcessInfo/">muduo ProcessInfo</a></li>  <li class="file"><a href="/2020/10/27/muduo-GzipFile/">muduo GzipFile</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory open">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder-open"></i>
                            &nbsp;
                            yfs
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/27/yfs-源码剖析（1）-锁服务/">yfs-源码剖析（1）--锁服务</a></li>  <li class="file"><a href="/2020/10/27/yfs-源码剖析（2）-基本文件服务/">yfs-源码剖析（2）--基本文件服务1</a></li>  <li class="file active"><a href="/2020/10/29/yfs-源码剖析（3）-基本文件服务2/">yfs-源码剖析（3）--基本文件服务2</a></li>  <li class="file"><a href="/2020/10/29/yfs-源码剖析（4）-Caching-locks/">yfs-源码剖析（4）--Caching locks</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            保研
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/09/15/在知乎上删除掉的保研经验/">在知乎上删掉的保研经历</a></li>  </ul> 
                    </li> 
                    
                    <li class="directory">
                        <a href="#" data-role="directory">
                            <i class="fa fa-folder"></i>
                            &nbsp;
                            网络编程
                        </a>
                         <ul class="unstyled" id="tree">  <li class="file"><a href="/2020/10/29/SimpleEpollServer源码阅读/">SimpleEpollServer源码阅读</a></li>  <li class="file"><a href="/2020/10/29/Liso-1-echo-server/">Liso(1) echo server</a></li>  <li class="file"><a href="/2020/10/29/Liso-2-httpServer/">Liso(2) httpServer</a></li>  <li class="file"><a href="/2020/10/29/springsnail源码分析/">springsnail源码分析</a></li>  </ul> 
                    </li> 
                     <li class="file"><a href="/2019/04/27/词法分析/">词法分析</a></li>  <li class="file"><a href="/2020/10/16/range-based-for-statement/">Range-based for statement</a></li>  <li class="file"><a href="/2020/10/19/实现简单的固定线程数的线程池/">实现简单的固定线程数的线程池</a></li>  <li class="file"><a href="/2020/10/19/实现时间轮/">实现时间轮</a></li>  <li class="file"><a href="/2020/10/29/网络编程通用结构体/">网络编程通用结构体</a></li>  </ul> 
    </div>
    <script>
        $(document).ready(function() {
            var iconFolderOpenClass  = 'fa-folder-open';
            var iconFolderCloseClass = 'fa-folder';
            var iconAllExpandClass = 'fa-angle-double-down';
            var iconAllPackClass = 'fa-angle-double-up';
            // Handle directory-tree expansion:
            // 左键单独展开目录
            $(document).on('click', '#categories a[data-role="directory"]', function (event) {
                event.preventDefault();

                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var subtree = $(this).siblings('ul');
                icon.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if (expanded) {
                    if (typeof subtree != 'undefined') {
                        subtree.slideUp({ duration: 100 });
                    }
                    icon.addClass(iconFolderCloseClass);
                } else {
                    if (typeof subtree != 'undefined') {
                        subtree.slideDown({ duration: 100 });
                    }
                    icon.addClass(iconFolderOpenClass);
                }
            });
            // 右键展开下属所有目录
            $('#categories a[data-role="directory"]').bind("contextmenu", function(event){
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconFolderOpenClass);
                var listNode = $(this).siblings('ul');
                var subtrees = $.merge(listNode.find('li ul'), listNode);
                var icons = $.merge(listNode.find('.fa'), icon);
                icons.removeClass(iconFolderOpenClass).removeClass(iconFolderCloseClass);
                if(expanded) {
                    subtrees.slideUp({ duration: 100 });
                    icons.addClass(iconFolderCloseClass);
                } else {
                    subtrees.slideDown({ duration: 100 });
                    icons.addClass(iconFolderOpenClass);
                }
            })
            // 展开关闭所有目录按钮
            $(document).on('click', '#allExpand', function (event) {
                event.preventDefault();
                
                var icon = $(this).children('.fa');
                var expanded = icon.hasClass(iconAllExpandClass);
                icon.removeClass(iconAllExpandClass).removeClass(iconAllPackClass);
                if(expanded) {
                    $('#sidebar .fa.fa-folder').removeClass('fa-folder').addClass('fa-folder-open')
                    $('#categories li ul').slideDown({ duration: 100 });
                    icon.addClass(iconAllPackClass);
                } else {
                    $('#sidebar .fa.fa-folder-open').removeClass('fa-folder-open').addClass('fa-folder')
                    $('#categories li ul').slideUp({ duration: 100 });
                    icon.addClass(iconAllExpandClass);
                }
            });  
        });
    </script>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
            <section id="main"><article id="post-yfs-源码剖析（3）-基本文件服务2" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
                    <div class="article-meta">
                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/yfs/">yfs</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/c-yfs-分布式/">c++ yfs 分布式</a>
    </div>

                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2020/10/29/yfs-源码剖析（3）-基本文件服务2/">
            <time datetime="2020-10-29T02:51:54.000Z" itemprop="datePublished">2020-10-29</time>
        </a>
    </div>


                        
                            <i class="fa fa-bar-chart"></i>
                            <span id="busuanzi_container_site_pv"><span id="busuanzi_value_page_pv"></span></span>    
                        
                        
                            <div class="article-meta-button">
                                <a href="https://github.com/zzywq/Wiki-site/raw/writing/source/_posts/yfs-源码剖析（3）-基本文件服务2.md"> Source </a>
                            </div>
                            <div class="article-meta-button">
                                <a href="https://github.com/zzywq/Wiki-site/edit/writing/source/_posts/yfs-源码剖析（3）-基本文件服务2.md"> Edit </a>
                            </div>
                            <div class="article-meta-button">
                                <a href="https://github.com/zzywq/Wiki-site/commits/writing/source/_posts/yfs-源码剖析（3）-基本文件服务2.md"> History </a>
                            </div>
                        
                    </div>
                
                
    
        <h1 class="article-title" itemprop="name">
            yfs-源码剖析（3）--基本文件服务2
        </h1>
    

            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
        
            
                <div id="toc" class="toc-article">
                <strong class="toc-title">文章目录</strong>
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#mkdir-amp-unlink"><span class="toc-number">1.</span> <span class="toc-text">mkdir&amp;unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Locking"><span class="toc-number">2.</span> <span class="toc-text">Locking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
                </div>
            
        
        
            <h2 id="mkdir-amp-unlink"><a href="#mkdir-amp-unlink" class="headerlink" title="mkdir&amp;unlink"></a>mkdir&amp;unlink</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">yfs_client::mkdir(inum parent, <span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">mode_t</span> mode, inum &amp;inum)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">LockGuard <span class="title">lg</span><span class="params">(m_lc, parent)</span></span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> data;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> dir_name;</span><br><span class="line">  <span class="keyword">if</span> (ec-&gt;get(parent, data) != extent_protocol::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dir_name = <span class="string">"/"</span> + <span class="built_in">std</span>::<span class="built_in">string</span>(name) + <span class="string">"/"</span>;</span><br><span class="line">  <span class="comment">// 目录已经存在</span></span><br><span class="line">  <span class="keyword">if</span> (data.find(dir_name) != <span class="built_in">std</span>::<span class="built_in">string</span>::npos)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> EXIST;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  inum = random_inum(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">if</span> (ec-&gt;put(inum, <span class="built_in">std</span>::<span class="built_in">string</span>()) != extent_protocol::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  data.append(dir_name + filename(inum) + <span class="string">"/"</span>);</span><br><span class="line">  <span class="keyword">if</span> (ec-&gt;put(parent, data) != extent_protocol::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> yfs_client::unlink(inum parent, <span class="keyword">const</span> <span class="keyword">char</span>* name)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function">LockGuard <span class="title">lg</span><span class="params">(m_lc, parent)</span></span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> data;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> file_name = <span class="string">"/"</span> + <span class="built_in">std</span>::<span class="built_in">string</span>(name) + <span class="string">"/"</span>;</span><br><span class="line">  <span class="keyword">size_t</span> pos, end, len; </span><br><span class="line">  inum inum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(ec-&gt;get(parent, data) != extent_protocol::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 没有这个文件</span></span><br><span class="line">  <span class="keyword">if</span>((pos = data.find(file_name)) == <span class="built_in">std</span>::<span class="built_in">string</span>::npos)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> NOENT;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  end = data.find_first_of(<span class="string">"/"</span>, pos+file_name.size());</span><br><span class="line">  <span class="keyword">if</span>(end == <span class="built_in">std</span>::<span class="built_in">string</span>::npos)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> NOENT;</span><br><span class="line">  &#125;</span><br><span class="line">  len = end - file_name.size() - pos;</span><br><span class="line">  inum = n2i(data.substr(pos+file_name.size(), len));</span><br><span class="line">  <span class="keyword">if</span>(!isfile(inum))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从目录中移除文件</span></span><br><span class="line">  data.erase(pos, end-pos+<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span>(ec-&gt;put(parent, data) != extent_protocol::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 删除文件</span></span><br><span class="line">  <span class="keyword">if</span>(ec-&gt;remove(inum) != extent_protocol::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> IOERR;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 fuse 中对应如下代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">fuseserver_mkdir(<span class="keyword">fuse_req_t</span> req, <span class="keyword">fuse_ino_t</span> parent, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span><br><span class="line">     <span class="keyword">mode_t</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">fuse_entry_param</span> <span class="title">e</span>;</span></span><br><span class="line">  <span class="comment">// In yfs, timeouts are always set to 0.0, and generations are always set to 0</span></span><br><span class="line">  e.attr_timeout = <span class="number">0.0</span>;</span><br><span class="line">  e.entry_timeout = <span class="number">0.0</span>;</span><br><span class="line">  e.generation = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Suppress compiler warning of unused e.</span></span><br><span class="line">  (<span class="keyword">void</span>) e;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line">  yfs_client::inum inum = <span class="number">0</span>;</span><br><span class="line">  yfs_client::status ret;</span><br><span class="line">  ret = yfs-&gt;mkdir(parent, name, mode, inum);</span><br><span class="line">  <span class="keyword">if</span>(ret == yfs_client::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    e.ino = inum;</span><br><span class="line">    getattr(inum, e.attr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(ret == yfs_client::EXIST)</span><br><span class="line">  &#123;</span><br><span class="line">    fuse_reply_err(req, EEXIST);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fuse_reply_entry(req, &amp;e);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  fuse_reply_err(req, ENOSYS);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove the file named @name from directory @parent.</span></span><br><span class="line"><span class="comment">// Free the file's extent.</span></span><br><span class="line"><span class="comment">// If the file doesn't exist, indicate error ENOENT.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Do *not* allow unlinking of a directory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">fuseserver_unlink(<span class="keyword">fuse_req_t</span> req, <span class="keyword">fuse_ino_t</span> parent, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// You fill this in for Lab 3</span></span><br><span class="line">  <span class="comment">// Success:	fuse_reply_err(req, 0);</span></span><br><span class="line">  <span class="comment">// Not found:	fuse_reply_err(req, ENOENT);</span></span><br><span class="line">  yfs_client::status ret = yfs-&gt;unlink(parent, name);</span><br><span class="line">  <span class="keyword">if</span>(ret == yfs_client::OK)</span><br><span class="line">  &#123;</span><br><span class="line">    fuse_reply_err(req, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fuse_reply_err(req, ENOENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h2><ul>
<li><p>What to lock?</p>
<p>At one extreme you could have a single lock for the whole file system, so that operations never proceed in parallel. At the other extreme you could lock each entry in a directory, or each field in the attributes structure. Neither of these is a good idea! A single global lock prevents concurrency that would have been okay, for example CREATEs in different directories. Fine-grained locks have high overhead and make deadlock likely, since you often need to hold more than one fine-grained lock.</p>
<p>You should associate a lock with each inumber. Use the file or directory’s <code>inum</code> as the name of the lock (i.e. pass the <code>inum</code> to <code>acquire</code> and <code>release</code>). The convention should be that any <code>yfs_client</code> operation should acquire the lock on the file or directory it uses, perform the operation, finish updating the extent server (if the operation has side-effects), and then release the lock on the <code>inum</code>. Be careful to release locks even for error returns from <code>yfs_client</code> operations.</p>
<p>You’ll use your lock server from Lab 1. <code>yfs_client</code> should create and use a <code>lock_client</code> in the same way that it creates and uses its <code>extent_client</code>.</p>
</li>
<li><p>Things to watch out for:</p>
<p>This is the first lab that creates files using two different YFS-mounted directories. If you were not careful in earlier labs, you may find that the components that assign <code>inum</code> for newly-created files and directories choose the same identifiers. One possible way to fix this may be to seed the random number generator differently depending on the process’s <code>pid</code>. The provided code has already done such seeding for you in the <code>main</code> function of <code>fuse.cc</code>.</p>
<p>This is also the first lab that writes null (‘\0’) characters to files. The <code>std::string(char*)</code> constructor treats ‘\0’ as the end of the string, so if you use that constructor to hold file content or the written data, you will have trouble with this lab. Use the <code>std::string(buf, size)</code> constructor instead..</p>
</li>
</ul>
<p>需要对之前的 yfs_client 进行修改：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">yfs_client</span> &#123;</span></span><br><span class="line">  extent_client *ec;</span><br><span class="line">  lock_client *m_lc;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>并且添加 lockGuard 类，实现 RAII，并且在 yfs_client 中需要加锁的地方添加 lockGuard。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LockGuard</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  LockGuard(lock_client *lc, lock_protocol::<span class="keyword">lockid_t</span> lid) : m_lc(lc), m_lid(lid)</span><br><span class="line">  &#123;</span><br><span class="line">    m_lc-&gt;acquire(m_lid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ~LockGuard()</span><br><span class="line">  &#123;</span><br><span class="line">    m_lc-&gt;release(m_lid);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  lock_client *m_lc;</span><br><span class="line">  lock_protocol::<span class="keyword">lockid_t</span> m_lid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<ul>
<li><a href="https://pdos.csail.mit.edu/archive/6.824-2012/labs/lab-3.html" target="_blank" rel="noopener">6.824 lab3</a></li>
<li><a href="https://liu-jianhao.github.io/2018/12/yfs%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%BA%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0%E5%9F%BA%E6%9C%AC%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1/" target="_blank" rel="noopener">yfs实现第二步——实现基本文件服务</a></li>
<li><a href="https://github.com/liu-jianhao/yfsCpp11/tree/master/lab3" target="_blank" rel="noopener">yfsCpp11s</a></li>
</ul>
</blockquote>

            </div>
        
        <footer class="article-footer">
        </footer>
    </div>
</article>


    
<nav id="article-nav">
    
        <a href="/2020/10/29/yfs-源码剖析（4）-Caching-locks/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    yfs-源码剖析（4）--Caching locks
                
            </div>
        </a>
    
    
        <a href="/2020/10/27/yfs-源码剖析（2）-基本文件服务/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">yfs-源码剖析（2）--基本文件服务1</div>
        </a>
    
</nav>





    
    




<!-- baidu url auto push script -->
<script type="text/javascript">
    !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=window.location.href,o=document.referrer;if(!e.test(r)){var n="//api.share.baidu.com/s.gif";o?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var t=new Image;t.src=n}}(window);
</script>     
</section>
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            ywq &copy; 2020 
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
            <br> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme - <a href="https://github.com/zthxxx/hexo-theme-Wikitten">wikitten</a>
            
                <br>
                <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_site_pv"></span></span>
                &nbsp;|&nbsp;
                <span id="busuanzi_container_site_pv"><i class="fa fa-user"></i> <span id="busuanzi_value_site_uv"></span></span>
            
        </div>
    </div>
</footer>

        

    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true,
            TeX: {
                equationNumbers: {
                  autoNumber: 'AMS'
                }
            }
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>